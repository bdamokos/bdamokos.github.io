<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Speedometer</title>
    <style>
      :root {
        --bg: #101418;
        --panel: #1a222c;
        --text: #f2f6fa;
        --muted: #90a2b4;
        --accent: #36d18e;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        font-family: "Avenir Next", "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #1c2733 0%, var(--bg) 55%);
        color: var(--text);
      }

      main {
        width: min(92vw, 420px);
        padding: 24px;
        border-radius: 18px;
        background: linear-gradient(180deg, #22303d 0%, var(--panel) 100%);
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.32);
        text-align: center;
      }

      h1 {
        margin: 0 0 8px;
        font-size: 1rem;
        color: var(--muted);
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .speed {
        font-size: clamp(3rem, 17vw, 5rem);
        font-weight: 700;
        line-height: 1;
      }

      .speed span {
        color: var(--accent);
      }

      .unit {
        margin-top: 4px;
        font-size: 1rem;
        color: var(--muted);
      }

      .secondary {
        margin-top: 10px;
        font-size: 0.95rem;
        color: var(--muted);
      }

      .status {
        margin: 12px 0 10px;
        min-height: 1.3em;
        font-size: 0.9rem;
        color: var(--muted);
      }

      button {
        border: 0;
        border-radius: 10px;
        padding: 10px 16px;
        background: var(--accent);
        color: #062514;
        font-size: 0.95rem;
        font-weight: 700;
      }

      button:disabled {
        opacity: 0.65;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Current Speed</h1>
      <div class="speed"><span id="kmh">0.0</span></div>
      <div class="unit">km/h</div>
      <div class="secondary"><span id="mph">0.0</span> mph</div>
      <p class="status" id="status">Tap start to request GPS.</p>
      <button id="start" type="button">Start GPS</button>
    </main>

    <script>
      const kmhEl = document.getElementById("kmh");
      const mphEl = document.getElementById("mph");
      const statusEl = document.getElementById("status");
      const startBtn = document.getElementById("start");

      let prevPos = null;
      let prevTime = 0;
      let watchId = null;
      let displayMps = 0;
      let targetMps = 0;
      let rafId = null;

      function toRad(deg) {
        return (deg * Math.PI) / 180;
      }

      function haversineMeters(a, b) {
        const R = 6371000;
        const dLat = toRad(b.latitude - a.latitude);
        const dLon = toRad(b.longitude - a.longitude);
        const lat1 = toRad(a.latitude);
        const lat2 = toRad(b.latitude);
        const h =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(h));
      }

      function updateSpeed(mps) {
        const safeMps = Number.isFinite(mps) && mps > 0 ? mps : 0;
        const kmh = safeMps * 3.6;
        const mph = safeMps * 2.236936;
        kmhEl.textContent = kmh.toFixed(1);
        mphEl.textContent = mph.toFixed(1);
      }

      function animateSpeed() {
        const delta = targetMps - displayMps;
        if (Math.abs(delta) < 0.02) {
          displayMps = targetMps;
          updateSpeed(displayMps);
          rafId = null;
          return;
        }
        displayMps += delta * 0.35;
        updateSpeed(displayMps);
        rafId = requestAnimationFrame(animateSpeed);
      }

      function setSpeed(mps) {
        targetMps = Math.min(80, Math.max(0, mps || 0));
        if (rafId === null) rafId = requestAnimationFrame(animateSpeed);
      }

      function onPosition(pos) {
        statusEl.textContent = "GPS active";

        const now = pos.timestamp;
        const gpsMps =
          Number.isFinite(pos.coords.speed) && pos.coords.speed >= 0
            ? pos.coords.speed
            : null;
        let calcMps = null;

        // Derived speed is often more responsive on iOS than coords.speed.
        if (prevPos && prevTime) {
          const dt = (now - prevTime) / 1000;
          if (dt > 0.2) {
            const meters = haversineMeters(prevPos, pos.coords);
            calcMps = meters / dt;
          }
        }

        let mps = gpsMps ?? calcMps ?? 0;
        if (calcMps != null && (pos.coords.accuracy || 999) <= 35) {
          mps = calcMps;
        }
        if (mps < 0.7) mps = 0;

        setSpeed(mps);
        prevPos = pos.coords;
        prevTime = now;
      }

      function onError(err) {
        if (err.code === 1) {
          statusEl.textContent = "Location access denied in Safari settings.";
          startBtn.disabled = false;
          return;
        }
        if (err.code === 2) {
          statusEl.textContent = "Location unavailable. Wait for GPS lock.";
          return;
        }
        if (err.code === 3) {
          statusEl.textContent = "Location timed out. Try again.";
          startBtn.disabled = false;
          return;
        }
        statusEl.textContent = "Unable to read GPS.";
        startBtn.disabled = false;
      }

      function startGps() {
        if (!("geolocation" in navigator)) {
          statusEl.textContent = "Geolocation is not supported in this browser.";
          return;
        }

        if (location.protocol === "file:") {
          statusEl.textContent =
            "Safari blocks GPS from local files. Open this page via HTTPS.";
          return;
        }

        statusEl.textContent = "Requesting GPS permission...";
        startBtn.disabled = true;

        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
        }

        watchId = navigator.geolocation.watchPosition(onPosition, onError, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        });
      }

      startBtn.addEventListener("click", startGps);
    </script>
  </body>
</html>
